
<style>

    *{
        box-sizing: border-box;
        text-decoration: none;
    }

    h2{
        width: 100%;
        text-align: center;
        margin: auto;
        background-color: rgb(0, 0, 0);
        color: white;
    }

    table{
        width: 100%;
        table-layout: auto;
    }

    table tr:hover{
        cursor: pointer;
        background-color: crimson;
        color: ghostwhite;
    }

    tr:nth-child(even) {background: #CCC}
    tr:nth-child(odd) {background: #FFF}

    .tab-bar{
        display: flex;
    }

    .tab-screen{
        overflow: scroll;
        border: solid;
        width: 60vw;
        height: 80vh;
        margin-top: 0px;
    }

    .tab-item{
        margin: 20px 0 0 0;
        padding: 15px 15px 5px 15px;
        border: rgb(10, 10, 10) solid;
        border-radius: 15px 15px 0 0;
    }

    .tab-item:hover{
        background-color: rgb(202, 202, 202);
        cursor: pointer;
    }

    .tab-item:target{
        background-color: black;
        color: ghostwhite;
        font-size: large;
    }

    .frmShow  > input, .frmShow > select, .frmShow  > label, .frmShow  > textarea{
        display: flex;
        width: 98%;
        margin-left: 10px;        
    }

    .frmShow  > label{
        margin-top: 10px;
    }    

    button, input[type='checkbox']{
        margin: 10px;
        float: right;
        padding: 5px 10px;
    }

    .frmCenter{
        border: solid 5px;
        border-radius: 10px;
        width: 95%;
        padding: 10px;
        align-items: center;
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        justify-content: center;
        margin: 10px auto;
    }
    .frmCenter > *{
        margin: 10px;
    }

</style>

<html>

    <div style="margin: 50px;">

        <div class="tab-bar">
            <div class="tab-item tab-emitente" style="background: black; color:white;"> Emitente</div>
            <div class="tab-item tab-fiscal" >Fiscal</div>
            <div class="tab-item tab-pedido" >Pedido</div>
            <div class="tab-item tab-cliente" >Cliente</div>            
            <div class="tab-item tab-itens" >Itens</div>
            <div class="tab-item tab-fatura" >Faturamento</div>
            <div class="tab-item tab-export" >Arquivos TXT</div>
        </div>
        
        <div class="tab-screen">        
            <div id="emitente" class="tab emitente">
                <h2>Emitente</h2>               
                    <form class="frmShow" id="C" method="POST" action="#">
                        <label> Razão Social *</label>
                        <input type="text" id="xNome" maxlength="60" value="" />
                        <label> Nome Fantasia </label>
                        <input type="text" id="xFant" maxlength="60" value=""/>
                        <label> Insc. Estadual </label>
                        <input type="text" id="IE" maxlength="14" value="" />
                        <input type="hidden" id="IEST" value=""  >                
                        <label> Insc. Municipal </label>
                        <input type="text" id="IM" maxlength="15" value="" />
                        <label> IE do Substituto Tributário </label>
                        <input type="text" id="IEST" maxlength="15" value="" />
                        <label> CNAE </label>
                        <input type="text" id="CNAE" maxlength="7"  value=""/>
                        <label> Regime Tributário </label>
                        <select id="CRT" >
                            <option value="1" selected>Simples Nacional</option>
                            <option value="2" >Simples Nacional - excesso de sublimite de receita bruta</option>
                            <option value="3" >Regime Normal.</option>
                        </select>
                    </form>
                    <form class="frmShow" id="C02" method="POST" action="#">
                        <label> CNPJ </label>
                        <input type="text" id="CNPJ" maxlength="14" value=""/>
                    </form>
                    <form class="frmShow" id="C05" method="POST" action="#">
                        <label> Endereço </label>
                        <input type="text" id="xLgr" maxlength="60" value="" />
                        <label> Número: </label>
                        <input type="text" id="nro" maxlength="5" value="" />
                        <label> Complemento </label>
                        <input type="text" id="cpl" maxlength="60"  value=""/>
                        <label> Bairro </label>
                        <input type="text" id="bairro" maxlength="60" value="" />
                        <label> Código do Municipio </label>
                        <input type="text" id="cMun" maxlength="60" value=""/>
                        <label>  Nome do Municipio</label>
                        <input type="text" id="xMun" maxlength="60" value=""/>
                        <label> Sigla da UF </label>
                        <input type="text" id="UF" maxlength="60" value="" />
                        <label> CEP </label>
                        <input type="text" id="CEP" maxlength="8" value=""/>
                        <label> Código do País  </label>
                        <input type="text" id="cPais" maxlength="4" value=""/>
                        <label> Nome do País </label>
                        <input type="text" id="xPais" maxlength="60" value=""/>
                        <label> Telefone </label>
                        <input type="text" id="fone" maxlength="14" value="" />
                    </form>
                    <button id="btnSaveEmit">Salvar</button>
                    
    
                
            </div>            
            <div id="fiscal" class="tab fiscal" style="display:none">
                <h2>Fiscal</h2>

                <form class="frmShow" id="B" method="POST" action="#" >
                    <input type="hidden" id="cUF" value="35" >      
    
                    <input type="hidden" id="cNF" value="">                 
    
                    <label> Natureza da Operação *</label>
                    <input type="text" id="natOp" maxlength="60" value=""/>
    
                    <label> Código do Modelo do Documento Fiscal </label>
                    <input type="text" id="mod" maxlength="2" value=""/>
                
                    <input type="hidden" id="serie" value="1" >                
    
                    <label> Numero da NF</label>
                    <input type="text" id="nNF" maxlength="9" value=""/>
    
                    <label> Data de emissão do Documento Fiscal </label>
                    <input type="date" id="dhEmi" value="" >
    
                    <label> Data e hora de Saída ou da Entrada da Mercadoria/Produto </label>
                    <input type="date" id="dhSaiEnt" value="">
    
                    <label> Tipo de Operação</label>
                    <select id="tpNF" >
                        <option value="0">Entrada</option>
                        <option value="1" selected>Saída</option>
                    </select>
    
                    <label> Identificador de Local de destino da operação</label>
                    <select id="idDest" >
                        <option value="1">Operação Interna</option>
                        <option value="2">Operação Interestadual</option>
                        <option value="3">Operação com o Exterior</option>
                    </select>
    
                    <input type="hidden" id="cMunFG" value="" >                
    
                    <label> Formato de Impressão do DANFE</label>
                    <select id="tpImp" >
                        <option value="1">Retrato</option>
                        <option value="2">Paisagem</option>
                    </select>
    
                    <label>Tipo de Emissão da NF-e</label>
                    <select id="tpEmis" >
                        <option value="1">Normal</option>
                        <option value="2">Contingência FS - emissão em contingência com impressão do DANFE em Formulário de Segurança</option>
                        <option value="4">Contingência EPEC - emissão em contingência com envio da Evento Prévio de Emissão em Contingência - EPEC</option>
                        <option value="5">Contingência FS-DA - emissão em contingência com impressão do DANFE em Formulário de Segurança para Impressão de Documento Auxiliar de Documento Fiscal Eletrônico (FS-DA)</option>
                        <option value="6">Contingência SVC-AN</option>
                        <option value="7">Contingência SVC-RS</option>
                        <option value="9">Contingência off-line NFC-e</option>
                    </select>
    
                    <input type="hidden" id="cDV" value="" >                
    
                    <label> Identificação do Ambiente</label>
                    <select id="tpAmb" >
                        <option value="1">Produção</option>
                        <option value="2">Homologação</option>
                    </select>
    
                    <label> Finalidade de emissão da NF-e</label>
                    <select id="finNFe" >
                        <option value="1">NF-e normal</option>
                        <option value="2">NF-e complementar</option>
                        <option value="3">NF-e de ajuste</option>
                    </select>
    
                    <label>Indica operação com o consumidor final</label>
                    <select id="indFinal" >
                        <option value="0">Normal</option>    
                        <option value="1">Consumidor Final</option>
                    </select>
    
                    <label>Indicador de presença do comprador no estabelecimento comercial no momento da operação</label>
                    <select id="indPres" >
                        <option value="0">Não se aplica (por exemplo Nota Fiscal Complementar ou de ajuste)</option>
                        <option value="1">Operação presencial</option>
                        <option value="2">Operação não presencial, pela Internet</option>
                        <option value="3">Operação não presencial, pelo tele atendimento</option>
                        <option value="4">NFC-e em operação com entrega em domicílio</option>
                        <option value="5">Operação não presencial, fora do estabelecimento</option>
                        <option value="9">Operação não presencial, outros</option>
                    </select>
    
                    <label>Processo de emissão da NF-e</label>
                    <select id="procEmi" >
                        <option value="0">emissão de NF-e com aplicativo do contribuinte</option>
                        <option value="1">emissão de NF-e avulsa pelo Fisco</option>
                        <option value="2">emissão de NF-e avulsa, pelo contribuinte com seu certificado digital, através do site do Fisco</option>
                        <option value="3">emissão NF-e pelo contribuinte com aplicativo fornecido pelo Fisco</option>
                    </select>
    
                    <input type="hidden" id="verProc" value="">
                    <input type="hidden" id="dhCont" value="">
                    <input type="hidden" id="xJust" value="" >    
                    </form>                
                    <div style="display:flex;">
                    <input type='checkbox' id='ckbSimpRem' /> 
                    <label for="">Simples Remessa </label>                 
                    </div>
    
                    <button id="btnSaveFiscal">Salvar</button>                
            </div>            
            <div id="pedido" class="tab pedido" style="display:none">
                <h2>Pedido</h2>
                
                <div class="frmCenter">
                    <label> Busca por: </label> 
                    <select id="selBuscaPed" name="campo_busca">
                        <option value="todos">Todos</option>
                        <option value="cod">Codigo</option>
                        <option value="num_ped">Numero</option>
                        <option value="cliente">Cliente</option>
                        <option value="varios">Vários Códigos</option>
                    </select>
                    <input type="text" id="edtBuscaPed" />
                    <button id="btnBuscaPed" >OK</button>
                </div>

                <div class="frmCenter">
                    <table id="tblBuscaPed"></table>
                </div>


            </div>
            <div id="cliente" class="tab cliente frmShow" style="display:none">
                <h2>Cliente</h2>
                    <label> Razão Social *</label>
                    <input type="text" id="xNome"  class="RazSoc" maxlength="60" value="" />
                    <label> Contribuinte ICMS</label>
                    <select id="indIEDest">
                        <option value="1">Contribuinte ICMS (informar a IE do destinatário)</option>
                        <option value="2">Contribuinte isento de Inscrição no cadastro de Contribuintes do ICMS (Não possui IE)</option>
                        <option value="9">Não Contribuinte, que pode ou não possuir Inscrição Estadual no Cadastro de Contribuintes do ICMS</option>
                    </select>
                    <label> Insc. Estadual </label>
                    <input type="text" id="IE" maxlength="14" value="" />
                    <input type="hidden" id="ISUF" value=""  >                
                    <label> Insc. Municipal </label>
                    <input type="text" id="IM" maxlength="15" value="" />
                    <label> Email </label>
                    <input type="text" id="email" value=""/>
                    <label> CNPJ </label>
                    <input type="text" id="CNPJ" maxlength="14" value=""/>
                    <label> Endereço </label>
                    <input type="text" id="xLgr" maxlength="60" value="" />
                    <label> Número: </label>
                    <input type="text" id="nro" maxlength="5" value="" />
                    <label> Complemento </label>
                    <input type="text" id="XCpl" maxlength="60"  value=""/>
                    <label> Bairro </label>
                    <input type="text" id="xBairro" maxlength="60" value="" />
                    <label> Código do Municipio </label>
                    <input type="text" id="cMun" maxlength="60" value="" readonly/>
                    <button id="btnBuscaIBGE"> Buscar no IBGE</button>
                    <label>  Nome do Municipio</label>
                    <input type="text" id="xMun" maxlength="60" value=""/>
                    <label> Sigla da UF </label>
                    <input type="text" id="UF" maxlength="60" value="" />
                    <label> CEP </label>
                    <input type="text" id="CEP" maxlength="8" value=""/>
                    <label> Código do País  </label>
                    <input type="text" id="cPais" maxlength="4" value=""/>
                    <label> Nome do País </label>
                    <input type="text" id="xPais" maxlength="60" value=""/>
                    <label> Telefone </label>
                    <input type="text" id="fone" maxlength="14" value="" />
                <button id="btnSaveCli">Salvar</button>
            </div>        
            <div id="itens" class="tab itens" style="display:none">
                <h2>Itens</h2>
                
                <table id="tblItens"></table>

<!--                    <button id="btnTeste">Teste*</button> -->


    </div>            
        <div id="fatura" class="tab fatura" style="display:none">
            <h2>Faturamento</h2>
            <form class="frmShow" id="B" method="POST" action="#" >

                <form class="frmShow" id="W" method="POST" action="#">
                    <label>Valor total da NF R$</label>
                    <input type="text" id="edtValorNF" value="0" onkeyup="money(this)">
                    <label>Desconto R$</label>
                    <input type="text" id="edtValorDesc" value='0' onkeyup="money(this)">
                    <label>Dias entre as Parcelas</label>
                    <input type="text" id="edtDiasParcelas" value="30/45/60">
                    <label> Tipo de Pagamento</label>
                    <select id="cmbPrazo">
                        <option value="0">A Vista</option>
                        <option value="1" selected>A Prazo</option>
                    </select>
                    <select id="cmbTpPgto">
                        <option value="01">Dinheiro</option>
                        <option value="02">Cheque</option>
                        <option value="03">Cartão de Crédito</option>
                        <option value="04">Cartão de Débito</option>
                        <option value="05">Crediário</option>
                        <option value="10">Vale Alimentação</option>
                        <option value="11">Vale Refeição</option>
                        <option value="12">Vale Presente</option>
                        <option value="13">Vale Combustível</option>
                        <option value="15" SELECTED>Boleto</option>
                        <option value="17">Pix</option>
                        <option value="90"> Sem pagamento (apenas para NFe)</option>
                        <option value="99">Outros</option>
                    </select>
                    <label>Texto Complementar</label>
                    <textarea  id="txaTextoCompl" rows="10"></textarea>
                
                </form>

                <select id="ckbEnt" style="margin: 10px; width: 98%;">
                    <option value="SAN" selected>Sanfonados</option>
                    <option value="FUN"> Tintas</option>
                    <option value="OUT">Outros</option>
                </select>

                <button id="btnGeraNFe">Gerar NFe</button>
                <button id="btnAddBol">Add Boletos</button>
            </form>
        </div>
        <div id="export" class="tab export" style="display:none">
            <h2>Arquivos TXT</h2>

            <form class="frmShow" id="TXT" method="POST" action="#">
                <select id="txtFiles" size="20"></select>                    
            </form>

            <button id="btnExportNFe">Exportar</button>

            </div>                
        </div>   

    </div> 
</html>
<script>

/* DECLARAÇÃO GLOBAL */

    const myNfe = new NFe();

    const today = new Date();        
    let dadosNF;
    let numPed = "";
/* CHAMADA DE FUNÇÕES INICIAL */    

    importData();


/* CHAMADA DE FUNÇÕES DO DOM */    

    document.getElementById('txtFiles').addEventListener('dblclick',()=>{
        document.getElementById('btnExportNFe').click()
    })
    document.querySelector('.tab-emitente').addEventListener('click',()=>{
        openTab('emitente')
    })
    document.querySelector('.tab-fiscal').addEventListener('click',()=>{
        openTab('fiscal')
    })
    document.querySelector('.tab-pedido').addEventListener('click',()=>{
        openTab('pedido')
    })
    document.querySelector('.tab-cliente').addEventListener('click',()=>{
        openTab('cliente')
    })    
    document.querySelector('.tab-itens').addEventListener('click',()=>{
        openTab('itens')
    })
    document.querySelector('.tab-fatura').addEventListener('click',()=>{
        openTab('fatura')
    })
    document.querySelector('.tab-export').addEventListener('click',()=>{
        openTab('export');
        const data = new URLSearchParams();        
            data.append("path", `../NF_txt`);

        const resp = getData("ajax/ajax_getFiles.php", data);                    
        resp.then((resolve)=>{
            const arr = JSON.parse(resolve);
            const sel = document.getElementById('txtFiles');
            sel.innerHTML = '';
            for(let i=2; i<arr.length; i++){
                const opt = document.createElement('option');
                if(i == 2){
                    opt.selected = true;
                }
                opt.innerHTML = arr[i];
                sel.appendChild(opt);

            }
        })                    
    })
    document.getElementById('btnSaveEmit').addEventListener('click',(event)=>{
        saveEmit();
        alert('Dados do emitente salvos com sucesso.')
        document.querySelector('.tab-fiscal').click();
        salvaNF();
    })
    document.getElementById('btnSaveFiscal').addEventListener('click',(event)=>{

        saveFiscal()

        alert('Dados fiscais salvos com sucesso.')
        document.querySelector('.tab-pedido').click();

        salvaNF();     
//                    console.log(dadosNF);
    })
    document.getElementById('btnSaveCli').addEventListener('click',()=>{

            const frmCliente = document.getElementById("cliente")

            const xNome = frmCliente.querySelector("#xNome").value
            const indIEDest = frmCliente.querySelector("#indIEDest").value
            const IE = frmCliente.querySelector("#IE").value
            const ISUF = frmCliente.querySelector("#ISUF").value
            const IM = frmCliente.querySelector("#IM").value
            const email = frmCliente.querySelector("#email").value
            const CNPJ = frmCliente.querySelector("#CNPJ").value
            const xLgr = frmCliente.querySelector("#xLgr").value
            const nro = frmCliente.querySelector("#nro").value
            const XCpl = frmCliente.querySelector("#XCpl").value
            const xBairro = frmCliente.querySelector("#xBairro").value
            const cMun = frmCliente.querySelector("#cMun").value
            const xMun = frmCliente.querySelector("#xMun").value
            const UF = frmCliente.querySelector("#UF").value
            const CEP = frmCliente.querySelector("#CEP").value
            const cPais = frmCliente.querySelector("#cPais").value
            const xPais = frmCliente.querySelector("#xPais").value
            const fone = frmCliente.querySelector("#fone").value

        myNfe.setE(xNome,CNPJ,IE,IM,xLgr,nro,XCpl,xBairro,xMun,UF,CEP,"1058","BRASIL",indIEDest,fone,"","",xNome)
//                    myNfe.setE(pedido[2],pedido[4],pedido[3],pedido[14],pedido[5],pedido[7],"",pedido[8],pedido[9],pedido[10],pedido[11],"1058","BRASIL")

    })
    document.getElementById('btnGeraNFe').addEventListener('click',(event)=>{
        event.preventDefault()
        saveEmit()
        saveFiscal()

        const valor = document.getElementById('edtValorNF').value
        const parc = document.getElementById('edtDiasParcelas').value
        const txtCpl = document.getElementById('txaTextoCompl').value
        const desc = document.getElementById('edtValorDesc').value
        const prazo = document.getElementById('cmbPrazo').value
        const TpPgto = document.getElementById('cmbTpPgto').value
        
        
        myNfe.setFat(valor,parc,txtCpl,desc,prazo,TpPgto);

        const nfTxt = myNfe.exportTxt();

        console.log(nfTxt)

        // Save File TXT
        const sFileName = `NFe${myNfe.A.nNF.toString().padStart(6, '0')}.txt`;	   // The file to save the data.

        let data = new URLSearchParams();        
            data.append("path", `../NF_txt/${sFileName}`);
            data.append("json", nfTxt);

        const resp = getData("ajax/ajax_saveJson.php", data);
        alert(` Arquivo ${sFileName} exportado com sucesso!`)
        
        dadosNF.NF[2].nNF = parseInt(dadosNF.NF[2].nNF) + 1
        salvaNF()
        atualiza()
        resp.then(()=>{
            document.querySelector('.tab-export').click();

        })                    


    })
    document.getElementById('btnAddBol').addEventListener('click',()=>{        
        const emp = document.querySelector('.RazSoc').value
        const dhIni = document.getElementById('dhEmi').value
        const pgto = document.getElementById('cmbTpPgto').value
        const origem = document.getElementById('ckbEnt').value
        const valor = (parseFloat(document.getElementById('edtValorNF').value) - parseFloat(document.getElementById('edtValorDesc').value)).toFixed(2)
        const dias = document.getElementById('edtDiasParcelas').value
        const parcelas = dias.split('/')
        const valorParc = (valor/parcelas.length).toFixed(2)
        const today = new Date(dhIni);
        today.setDate(today.getDate() + 1)

        for(let i=0; i<parcelas.length; i++){
            const ref = 'NF-'+document.getElementById('nNF').value +' '+(i+1)+'/'+ parcelas.length

            const dia = new Date();
            dia.setDate(today.getDate() + parseInt(parcelas[i]));
            const data = (dia.getFullYear()+'-'+(dia.getMonth()+1).toString().padStart(2, '0')+'-'+dia.getDate().toString().padStart(2, '0'))
            const query = `INSERT INTO tb_financeiro ( tipo, ref, emp, preco, data_pg, data_ini, resp, origem, pgto) VALUES ('ENTRADA', '${ref}', '${emp}', '${valorParc}','${data}', '${dhIni}' ,'SISTEMA','${origem}','${pgto}');`
            
            queryDB(query)

        }
        alert('Boletos adicionados com sucesso')
        document.getElementById('btnAddBol').disabled = true;
    })
    document.getElementById('btnBuscaPed').addEventListener('click',()=>{
        const sel = document.getElementById('selBuscaPed');
        const edt = document.getElementById('edtBuscaPed');
        let query = "";      

        if (sel.value == "todos"){

            query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND p.status = 'FECHADO' ORDER BY p.data_ped DESC ;`;
        } else if (sel.value == "num_ped"){
            query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND p.num_ped = '${edt.value}' AND p.status = 'FECHADO';`;
        } else if (sel.value == "cliente"){
            query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND e.nome LIKE '%${edt.value}%' AND p.status = 'FECHADO' ORDER BY p.data_ped DESC ;`;

        } else if (sel.value == "cod"){
            query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND p.id = '${edt.value}' AND p.status = 'FECHADO';`;
        } else if (sel.value == "varios"){
            const aux =  edt.value.split('/');

            query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND p.id = '${edt.value}' AND p.status = 'FECHADO';`;
            }            

        const data = new URLSearchParams();        
            data.append("query", query);

        const resp = getData("ajax/ajax.php", data);

        resp.then((json)=>{
            const data = JSON.parse(json);
            const tbl =  document.getElementById('tblBuscaPed');
            tbl.innerHTML = "<tr> <th>Cod.</th> <th>Numero</th> <th>Cliente</th> <th>CNPJ</th> <th>Data</th></tr>";

            for(let i=0; i<data.length; i++){
                const row = document.createElement('tr');
                row.className = 'tab-row';
                const fields = ['id','num_ped','nome','cnpj','data_ped'];

                for(let j=0; j< Object.entries(data[i]).length; j++){
                    const dados = Object.entries(data[i]);
                    const col = document.createElement('td');
                    if(!fields.includes(dados[j][0])){
                        col.style = "display:none;"
                    }
                    col.innerHTML = dados[j][1];
                    row.appendChild(col);                        
                }
        
                row.addEventListener('dblclick',(event)=>{
                    function soNum(C){
                        let resp = '';
                        let perm = ['0','1','2','3','4','5','6','7','8','9'];
                        for(let i=0; i< C.length; i++){
                            if(perm.includes(C[i])){
                                resp += C[i]
                            }
                        }
                        return resp;
                    }

                    let target = event.target;
                    while (target.nodeName != 'TR') {
                        target = target.parentElement;
                    }
                    let row = target.cells; 

                    const pedido = [];
                    for(let k=0; k<row.length; k++){
                        pedido.push(row[k].innerHTML);
                    }

                    console.log(pedido);
                    loadCliente(pedido);
                    const indIEDest = document.getElementById("cliente").querySelector("#indIEDest").value
//                    console.log(indIEDest);
                    myNfe.setE(pedido[2],pedido[4],pedido[3],pedido[14],pedido[5],pedido[7],"",pedido[8],pedido[9],pedido[10],pedido[11],"1058","BRASIL",indIEDest)
                    numPed = pedido[1];

//                                const frmCliente = document.getElementById("cliente")
                    const cMun = document.getElementById("cliente").querySelector("#cMun");

                    IBGE_cMun(pedido[10],pedido[9],cMun,"I");

                    const pedcod = pedido[0];
                    const query = ` SELECT p.cod, p.descricao, p.ncm, p.unidade, i.qtd, i.preco, p.tipo, i.und, p.cfop
                                    FROM tb_item_ped as i 
                                    INNER JOIN tb_produto AS p
                                    ON i.id_ped = ${pedcod}
                                    AND i.id_prod = p.id;`;


                    const data = new URLSearchParams();        
                    data.append("query", query);

                    const resp = getData("ajax/ajax.php", data);

                    resp.then((json)=>{
                        const data = JSON.parse(json);
                        const tab = document.getElementById('tblItens');
                        tab.innerHTML = '<tr><th>CFOP</th><th>Cod</th><th>Descrição</th><th>Qtd.</th><th>Preço</th><th>Und.</th></tr>';
                        let total = 0;
                        dadosNF.itens = [];
                        let prefCFOP = "5"
                        if(pedido[10] != dadosNF.NF[5].UF){
                            prefCFOP = "6"
                        }
                        if(dadosNF.NF[2].tpNF == 0){
                            prefCFOP = "1"
                        }

//                        console.log(prefCFOP)
                        myNfe.clearItens()
                        for(let i=0; i<data.length; i++){ // 1x a cada item do 
                            let posCFOP = data[i].cfop
                            if(posCFOP == null){
                                    posCFOP = "102"
                                if(parseInt(data[i].cod) < 1000){
                                    posCFOP = "101"
                                }
                            }else{
                                posCFOP = posCFOP.substring(1,4)
                            }

//                            console.log(prefCFOP+posCFOP)
                            myNfe.addItem(i+1,data[i].cod.trim(),data[i].descricao.trim(),data[i].ncm.trim(),data[i].und.trim(),parseFloat(data[i].qtd).toFixed(4),parseFloat(data[i].preco),prefCFOP+posCFOP)
                            const campos = Object.entries(data[i]);
                            const perm = ['cod','descricao','ncn','und','qtd','preco'];

                            const row = document.createElement('tr');
                            row.innerHTML = `<td>${prefCFOP+posCFOP}</td>`
                            for(let j=0; j<campos.length; j++){
                                const col = document.createElement('td');
                                if(!perm.includes(campos[j][0])){
                                    col.style.display = 'none';
                                }
                                col.innerHTML = campos[j][1];

                                row.appendChild(col);
                            }
                            total += parseFloat(data[i].preco) * parseFloat(data[i].qtd) ;
//                                        console.log(data[i].preco) 

                            row.addEventListener('dblclick',(event)=>{
                            
                                let target = event.target;
                                while (target.nodeName != 'TR') {
                                    target = target.parentElement;
                                }
                                let cel = target.cells;
                                var cfop = prompt("CFOP:", cel[0].innerHTML);
                                if (cfop != null) {
                                    cel[0].innerHTML = cfop
                                    myNfe.addItem(i+1,data[i].cod.trim(),data[i].descricao.trim(),data[i].ncm.trim(),data[i].und.trim(),parseFloat(data[i].qtd).toFixed(4),parseFloat(data[i].preco),cfop)
                                }
                            
                            })

                            tab.appendChild(row)

                        }
                        const row = document.createElement('tr');
                        const col = document.createElement('th');
                        col.colSpan = 6
                        col.style.textAlign = "right";
                        col.innerHTML = 'Total R$'+total.toLocaleString('pt-br', {minimumFractionDigits: 2});
                        row.appendChild(col)
                        tab.appendChild(row)
//                                    console.log(total.toLocaleString('pt-br', {minimumFractionDigits: 2}) )


// tela de fatura                                    
                        document.getElementById('edtValorNF').value = total.toFixed(2);
                        let txtComp = `DOC. EMITIDO POR ME OU EPP OPTANTE S.NACIONAL, NÃO GERA DIREITO A CREDITO FISCAL DE ISSQN E IPI, PERMITE O APROVEITAMENTO DE CREDITO DO ICMS NO VALOR DE  R$ ${(total * 0.0282).toFixed(2)} CORRESPONDENTE A ALIQUOTA DE 2,82% NOS TERMOS DO ARTIGO 23 DA LC 123.`;
                        if(numPed.trim != ""){
                            txtComp += ` Aprovado conforme pedido ${numPed}`;
                        }


                        document.getElementById('txaTextoCompl').innerHTML = txtComp;


                        dadosNF.fatura = [];


                    })

//                                console.log(query);

                    dadosNF.NF[6].xNome = pedido[2];
                    dadosNF.NF[6].IE = soNum(pedido[3]);
                    dadosNF.NF[6].indIEDest = indIEDest;
                    // dados do cliente do pedido
                    dadosNF.NF[7].CNPJ = soNum(pedido[4]);
                    dadosNF.NF[8].xLgr = pedido[5].trim();
                    dadosNF.NF[8].nro = pedido[7].trim();
                    dadosNF.NF[8].XCpl = '';
                    dadosNF.NF[8].xBairro = pedido[8].trim();
                    dadosNF.NF[8].xMun = pedido[9].trim();
                    dadosNF.NF[8].UF = pedido[10].trim();
                    dadosNF.NF[8].CEP = soNum(pedido[11]);
                    dadosNF.NF[8].cPais = '1058';
                    dadosNF.NF[8].fone = soNum(pedido[12]);
//                                IBGE_cMun();
                    IBGE_cMun(UF,xMun,cMun);
                    atualiza()

                    document.querySelector('.tab-cliente').click();
                 
                })                    
                tbl.appendChild(row);
            }

        })
        
    })

    function saveFiscal(){
        const frmB = document.getElementById('B');

        const cUF = frmB.querySelector('#cUF').value;
        const cNF = frmB.querySelector('#cNF').value;
        const natOp = frmB.querySelector('#natOp').value;
        const mod = frmB.querySelector('#mod').value;
        const nNF = frmB.querySelector('#nNF').value;
        const dhEmi = frmB.querySelector('#dhEmi').value;
        const dhSaiEnt = frmB.querySelector('#dhSaiEnt').value;
        const tpNF = frmB.querySelector('#tpNF').value;
        const idDest = frmB.querySelector('#idDest').value;
        const cMunFG = frmB.querySelector('#cMunFG').value;
        const tpImp = frmB.querySelector('#tpImp').value;
        const tpEmis = frmB.querySelector('#tpEmis').value;
        const cDV = frmB.querySelector('#cDV').value;
        const tpAmb = frmB.querySelector('#tpAmb').value;
        const finNFe = frmB.querySelector('#finNFe').value;
        const indFinal = frmB.querySelector('#indFinal').value;
        const indPres = frmB.querySelector('#indPres').value;
        const procEmi = frmB.querySelector('#procEmi').value;
        const verProc = frmB.querySelector('#verProc').value;
        const dhCont = frmB.querySelector('#dhCont').value;
        const xJust = frmB.querySelector('#xJust').value;

        document.getElementById('cNF').value = Math.floor(Math.random() * (99999999 - 10000000) + 10000000) ; // novo cNF

        dadosNF.NF[2].cUF = cUF;
        dadosNF.NF[2].cNF = cNF;
        dadosNF.NF[2].natOp = natOp;
        dadosNF.NF[2].mod = mod;
        dadosNF.NF[2].nNF = nNF;
        dadosNF.NF[2].dhEmi = dhEmi;
        dadosNF.NF[2].dhSaiEnt = dhSaiEnt;
        dadosNF.NF[2].tpNF = tpNF;
        dadosNF.NF[2].idDest = idDest;
        dadosNF.NF[2].cMunFG = cMunFG;
        dadosNF.NF[2].tpImp = tpImp;
        dadosNF.NF[2].tpEmis = tpEmis;
        dadosNF.NF[2].cDV = cDV;
        dadosNF.NF[2].tpAmb = tpAmb;
        dadosNF.NF[2].finNFe = finNFe;
        dadosNF.NF[2].indFinal = indFinal;
        dadosNF.NF[2].indPres = indPres;
        dadosNF.NF[2].procEmi = procEmi;
        dadosNF.NF[2].dhCont = dhCont;
        dadosNF.NF[2].xJust = xJust;        
    }

    function saveEmit(){
        const razsoc = document.getElementById('xNome').value;
        const fantasia = document.getElementById('xFant').value;
        const IE = document.getElementById('IE').value;
        const IM = document.getElementById('IM').value;
        const IEST = document.getElementById('IEST').value;
        const CNAE = document.getElementById('CNAE').value;
        const regtrib = document.getElementById('CRT').value;
        const CNPJ = document.getElementById('CNPJ').value;
        const end = document.getElementById('xLgr').value;
        const num = document.getElementById('nro').value;
        const comp = document.getElementById('cpl').value;
        const bairro = document.getElementById('bairro').value;
        const codMun = document.getElementById('cMun').value;
        const nomeMun = document.getElementById('xMun').value;
        const UF = document.getElementById('UF').value;
        const CEP = document.getElementById('CEP').value;
        const codPais = document.getElementById('cPais').value;
        const nomePais = document.getElementById('xPais').value;
        const telefone = document.getElementById('fone').value;
        const natOp = document.getElementById('natOp').value;
        const mod = document.getElementById('mod').value;
        const serie = document.getElementById('serie').value;
        const nNF = document.getElementById('nNF').value;
        const dhEmi = document.getElementById('dhEmi').value;
        const dhSai = document.getElementById('dhSaiEnt').value;
        const tipOp = document.getElementById('tpNF').value;
        const destOp = document.getElementById('fone').value;



        myNfe.setAB(CNPJ,nNF,nomeMun,UF,natOp);
        myNfe.setC(razsoc,CNPJ,IE,IM,end,num,comp,bairro,nomeMun,UF,CEP,codPais,nomePais,telefone,fantasia,CNAE,regtrib,IEST);



        dadosNF.NF[3].xNome = razsoc;
        dadosNF.NF[3].xFant = fantasia;
        dadosNF.NF[3].IE = IE;
        dadosNF.NF[3].IM = IM;
        dadosNF.NF[3].CNAE = CNAE;
        dadosNF.NF[3].CRT = regtrib;
        dadosNF.NF[4].CNPJ = CNPJ;
        dadosNF.NF[5].xLgr = end;
        dadosNF.NF[5].nro = num;
        dadosNF.NF[5].cpl = comp;
        dadosNF.NF[5].bairro = bairro;
        dadosNF.NF[5].cMun = codMun;
        dadosNF.NF[5].xMun = nomeMun;
        dadosNF.NF[5].UF = UF;
        dadosNF.NF[5].CEP = CEP;
        dadosNF.NF[5].cPais = codPais;
        dadosNF.NF[5].xPais = nomePais;
        dadosNF.NF[5].fone = telefone;        
    }

    function loadCliente(obj){

//        console.log(obj)
/*
        query =  `SELECT p.id, p.num_ped, e.nome, e.ie, e.cnpj, e.endereco, p.status, e.num, e.bairro, e.cidade, e.estado, e.cep, e.tel, p.data_ped, e.im
                    FROM tb_pedido AS p INNER JOIN tb_empresa AS e 
                    ON p.id_emp = e.id AND p.status = 'FECHADO' ORDER BY p.data_ped DESC ;`;
*/


        const frmCliente = document.getElementById("cliente")

        frmCliente.querySelector("#xNome").value = obj[2]
        frmCliente.querySelector("#IE").value = obj[3]
        frmCliente.querySelector("#ISUF").value = ""
        frmCliente.querySelector("#IM").value = obj[14]
        frmCliente.querySelector("#email").value = ""
        frmCliente.querySelector("#CNPJ").value = obj[4]
        frmCliente.querySelector("#xLgr").value = obj[5]
        frmCliente.querySelector("#nro").value = obj[7]
        frmCliente.querySelector("#XCpl").value = ""
        frmCliente.querySelector("#xBairro").value = obj[8]
        frmCliente.querySelector("#cMun").value = ""
        frmCliente.querySelector("#xMun").value = obj[9]
        frmCliente.querySelector("#UF").value = obj[10]
        frmCliente.querySelector("#CEP").value = obj[11]
        frmCliente.querySelector("#cPais").value = ""
        frmCliente.querySelector("#xPais").value = "BRASIL"
        frmCliente.querySelector("#fone").value = obj[12]

//        console.log(frmCliente.querySelector("#IE").value.trim())

        if(obj[3].trim() === ""){
            frmCliente.querySelector("#indIEDest").value = "2"
        }else{
            frmCliente.querySelector("#indIEDest").value = "1"
        }

        
    }

    document.getElementById('btnBuscaIBGE').addEventListener('click',(event)=>{
        event.preventDefault();
//                    salvaNF("E05",8);

            const frmCliente = document.getElementById("cliente")
            const xMun = frmCliente.querySelector("#xMun").value
            const UF = frmCliente.querySelector("#UF").value
            const cMun = frmCliente.querySelector("#cMun");

            IBGE_cMun(UF,xMun,cMun);


    })
    document.getElementById('btnExportNFe').addEventListener('click',()=>{

        const file = document.getElementById('txtFiles').value;
        const path = 'NF_txt/' + file;

        
        var link = document.createElement("a");
            link.download = file;
            link.href = path;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            delete link; 




    })            
          
/* DECLARAÇÃO DE FUNÇÕES */

    function openTab(tab) {
        let x = document.getElementsByClassName("tab");
        
        for (let i = 0; i < x.length; i++) {
            x[i].style.display = "none";  
        }
        x = document.getElementsByClassName(tab);
        for (let i = 0; i < x.length; i++) {
            x[i].style.display = "block";          
        } 
        x = document.getElementsByClassName("tab-item");
        for (let i = 0; i < x.length; i++) {
            x[i].style.background = "white";  
            x[i].style.color = "black";         
        }                     
        x = document.getElementsByClassName("tab-"+tab);
        for (let i = 0; i < x.length; i++) {
            x[i].style.background = "black"; 
            x[i].style.color = "white";         
        }       
                    
    }

    function importData(){
        const data = new URLSearchParams();        
            data.append("path", "../config/nfe.json");

        const resp = getData("ajax/ajax_getJson.php", data);
        resp.then((json)=>{                 
            const data = JSON.parse(json);
            dadosNF = data;
            atualiza();
//            console.log(dadosNF)

        })            
    }

    function atualiza(){

        function run(id,index){
            const frm = document.getElementById(id);
            for(let i=0; i<frm.length; i++){
                if(frm[i].id in dadosNF.NF[index]){
                    frm[i].value = dadosNF.NF[index][frm[i].id].toString().trim() ;
                }
            }
        }
        run("C",3);
        run("C02",4);
        run("C05",5);
        run("B",2);
    
        
        //atualiza as datas para a data atual
        const date = today.getFullYear()+"-"+(today.getMonth()+1).toString().padStart(2, '0')+"-"+today.getDate().toString().padStart(2, '0');
        document.getElementById('dhEmi').value = date
        document.getElementById('dhSaiEnt').value = date


    }

    function salvaNF(){
//                    const frm = document.getElementById(id);
/*
        for(let i=0; i<frm.length; i++){
            dadosNF.NF[index][frm[i].id] = frm[i].value.trim();
        }
*/          
        const json = JSON.stringify(dadosNF);

//        console.log(json)

        const data = new URLSearchParams();        
            data.append("path", "../config/nfe.json");
            data.append("json", json);

        const resp = getData("ajax/ajax_saveJson.php", data);

//        console.log(json)

    }

    function getData(url,data){
        const myRequest = new Request(url,{
            method : "POST",
            body : data
        });                

        return new Promise((resolve,reject) =>{

            fetch(myRequest)
            .then(function (response){

                if (response.status === 200) { 
                    resolve(response.text());
                } else { 
                    reject(new Error("Houve algum erro na comunicação com o servidor"));
                } 
            })                    
        });            
    }

    function IBGE_cMun(UF,xMun,field){
        let resp = null
        dadosNF.NF[8].cMun = '';
        const UF_cod = new Promise((resolve,reject) =>{

            fetch("https://servicodados.ibge.gov.br/api/v1/localidades/estados")
            .then(function (response){

                if (response.status === 200) { 
                    resolve(response.text());
                } else { 
                    reject(new Error("Houve algum erro na comunicação com o servidor"));
                } 
            })                    
        });   

        UF_cod.then((resolve)=>{
            const json = JSON.parse(resolve);
            for(let i=0; i<json.length; i++){
                if(json[i].sigla == UF){

                    const Mun_cod = new Promise((resolve,reject) =>{

                        fetch(`https://servicodados.ibge.gov.br/api/v1/localidades/estados/${json[i].id}/municipios`)
                        .then(function (response){

                            if (response.status === 200) { 
                                resolve(response.text());
                            } else { 
                                reject(new Error("Houve algum erro na comunicação com o servidor"));
                            } 
                        })                    
                    }); 

                    Mun_cod.then((resolve)=>{
                        const json = JSON.parse(resolve);
                        for(let j=0; j<json.length; j++){

                            if(json[j].nome.trim().toLowerCase() == xMun.trim().toLowerCase()){
                                field.value = json[j].id                              
                                break;
                            }
                        }

                    })
                
                }
            }
            
        })
    }

</script>